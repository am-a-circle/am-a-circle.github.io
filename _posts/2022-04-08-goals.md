---
title: "Cached Credentials Test"
author: am-a-circle
date: 2022-04-08 13:53:00 +0800
categories: [Goal Setting]
tags: [redteam]
math: false
mermaid: false
---
# Cached Credentials

# Overview/Concept

Why we can crack password

Scenario

- If geektoys/paul logins onto his laptop (with the smiley face) , this credentials will be cache.
    - If a domain admin, geektoys/james remote desktop and login as geektoys/james on paul laptop this credentials is also cache!
- A malicious hacker send a phishing email to geektoys/paul which downloads a malware to have a reverse payload back to his attacking machine to compromise his account
    - Adversary try to escalate privileges as local administrator and then easily go to ntauthority/system
- Able to steal cache credential stored on **C:\windows\system32\config\sam** to crack the credentials stored to steal domain admin creds without touching Domain controller or AD database file.

# ****Dumping and Cracking mscash - Cached Domain Credentials****

## What is mscash

- **MScash** is Microsoft hashing algorithm which is used to store cached domain credentials locally after successful logon.
    - Not passable between computer like LM/NT password or Kerberos Tickets - i.e PTH attacks will not work.

## Mimikatz

- Use mimikatz to dump cached credentials
    
    ```bash
    privlege::debug
    token::elevate
    lsadump::caache
    ```
    

## Cracking with Hashcat

- Susceptible to offline crack
    - To crack mscache with hashcat, it should be in the following format:
    
    ```bash
    $DCC2$10240#username#hash
    ```
    
    - Example:
    
    ```bash
    hashcat -m2100 '$DCC2$10240#administrator#place-mscash-hash-here' /usr/share/wordlists/rockyou.txt --force --potfile-disable
    ```
    

# Mitigation for cached credentials

- For priv users, add them to **Protected Users** group in AD and their credentials will not be cached.
- Set interactive logon : Number of previous logons to cache ( in case DC is not available) to 0. To disable local caching of logon information. However, inconvenient for users canâ€™t login when Domain controller is not available.
